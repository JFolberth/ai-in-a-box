name: CI - Build and Test

# Prevent duplicate runs: 
# - Run on push to main/develop only (not feature branches)
# - Run on pull requests to main/develop (covers feature branch changes)
# - Use concurrency groups to cancel previous runs
on:
  push:
    branches: [main, develop]
    paths:
      - 'src/**'
      - '.github/workflows/**'
      - 'infra/**'
      - 'package*.json'
      - '*.csproj'
  pull_request:
    branches: [main, develop]
    paths:
      - 'src/**'
      - '.github/workflows/**'
      - 'infra/**'
      - 'package*.json'
      - '*.csproj'

# Cancel previous runs when pushing new commits
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  DOTNET_VERSION: '8.0.x'

jobs:
  bicep-validation:
    name: Bicep Infrastructure Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Azure CLI Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
      
    - name: Validate Main Orchestrator Template
      run: |
        echo "üîç Validating main orchestrator Bicep template..."
        az deployment sub what-if \
          --location "eastus2" \
          --template-file "infra/main-orchestrator.bicep" \
          --parameters "infra/dev-orchestrator.parameters.bicepparam"
        echo "‚úÖ Main orchestrator validation completed"
          
    - name: Create temporary resource group for validation
      run: |
        echo "üèóÔ∏è Creating temporary resource group for validation..."
        TEMP_RG="rg-temp-bicep-validation-${{ github.run_number }}"
        az group create --name "$TEMP_RG" --location "eastus2" --tags Purpose=CI-Validation RunNumber=${{ github.run_number }}
        echo "TEMP_RESOURCE_GROUP=$TEMP_RG" >> $GITHUB_ENV
        
    - name: Validate Backend Environment Template
      run: |
        echo "üîç Validating backend environment Bicep template..."
        az deployment group what-if \
          --resource-group "${{ env.TEMP_RESOURCE_GROUP }}" \
          --template-file "infra/environments/backend/main.bicep" \
          --parameters "infra/environments/backend/example-parameters.bicepparam"
        echo "‚úÖ Backend environment validation completed"
          
    - name: Validate Frontend Environment Template
      run: |
        echo "üîç Validating frontend environment Bicep template..."
        az deployment group what-if \
          --resource-group "${{ env.TEMP_RESOURCE_GROUP }}" \
          --template-file "infra/environments/frontend/main.bicep" \
          --parameters "infra/environments/frontend/example-parameters.bicepparam"
        echo "‚úÖ Frontend environment validation completed"
          
    - name: Cleanup temporary resource group
      if: always()
      run: |
        echo "üßπ Cleaning up temporary resource group..."
        if [ -n "${{ env.TEMP_RESOURCE_GROUP }}" ]; then
          az group delete --name "${{ env.TEMP_RESOURCE_GROUP }}" --yes --no-wait
        fi
        
    - name: Bicep validation summary
      run: |
        echo "## üèóÔ∏è Bicep Infrastructure Validation Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ‚úÖ Templates Validated Successfully" >> $GITHUB_STEP_SUMMARY
        echo "- **Main Orchestrator**: \`infra/main-orchestrator.bicep\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Backend Environment**: \`infra/environments/backend/main.bicep\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Frontend Environment**: \`infra/environments/frontend/main.bicep\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üîç Validation Scope" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ Bicep template syntax and compilation" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ Parameter file compatibility" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ Module references and paths" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ RBAC role definitions and scope" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ Resource dependencies and naming" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üöÄ Deployment Ready" >> $GITHUB_STEP_SUMMARY
        echo "Infrastructure templates are validated and ready for deployment using:" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
        echo "./deploy-scripts/deploy.ps1 -SubscriptionId \"your-subscription-id\"" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  frontend-build:
    name: Frontend Build
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: src/frontend/package-lock.json
        
    - name: Install frontend dependencies
      working-directory: ./src/frontend
      run: npm ci
      
    - name: Build frontend
      working-directory: ./src/frontend
      run: npm run build
    
    - name: Run frontend tests
      working-directory: ./src/frontend
      run: npm run test:ci
      
    - name: Build frontend (dev mode)
      working-directory: ./src/frontend
      run: npm run build:dev
      
    - name: Upload frontend build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: frontend-dist
        path: src/frontend/dist/
        retention-days: 5

  backend-build:
    name: Backend Build
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Restore backend dependencies
      working-directory: ./src/backend
      run: dotnet restore
      
    - name: Build backend
      working-directory: ./src/backend
      run: dotnet build --configuration Release --no-restore
      
    - name: Test backend
      working-directory: ./src/backend/tests/AIFoundryProxy.Tests
      run: dotnet test --configuration Release --verbosity normal
      
    - name: Publish backend
      working-directory: ./src/backend
      run: dotnet publish --configuration Release --no-build --output ./publish
      
    - name: Upload backend build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: backend-publish
        path: src/backend/publish/
        retention-days: 5

  deploy-ade-frontend:
    name: Deploy ADE Frontend
    runs-on: ubuntu-latest
    needs: [bicep-validation, frontend-build]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Download frontend artifacts
      uses: actions/download-artifact@v4
      with:
        name: frontend-dist
        path: ./src/frontend/dist/
        
    - name: Azure CLI Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Create ADE Environment
      id: create-ade
      run: |
        echo "üöÄ Creating ADE environment for frontend deployment..."
        
        # Generate unique environment name
        ADE_ENV_NAME="cicd-fd-${{ github.run_number }}"
        echo "ADE_ENVIRONMENT_NAME=$ADE_ENV_NAME" >> $GITHUB_ENV
        
        # Create ADE environment
        echo "üì¶ Deploying ADE environment: $ADE_ENV_NAME"
        az devcenter dev environment create \
          --dev-center-name "devecnter-eus-dev" \
          --project-name "ai-foundry" \
          --catalog-name "ai-in-abox-infrastructure" \
          --environment-definition-name "AI_Foundry_SPA_Frontend" \
          --environment-type "dev" \
          --name "$ADE_ENV_NAME" \
          --parameters @infra/environments/frontend/ade.parameters.json \
          --no-wait
        
        echo "‚è≥ Waiting for ADE environment deployment to complete..."
        
        # Wait for deployment to complete (timeout after 10 minutes)
        timeout=600
        elapsed=0
        while [ $elapsed -lt $timeout ]; do
          status=$(az devcenter dev environment show \
            --dev-center-name "devecnter-eus-dev" \
            --project-name "ai-foundry" \
            --name "$ADE_ENV_NAME" \
            --query "provisioningState" \
            --output tsv 2>/dev/null || echo "NotFound")
          
          echo "üîç Environment status: $status (${elapsed}s elapsed)"
          
          if [ "$status" = "Succeeded" ]; then
            echo "‚úÖ ADE environment deployed successfully!"
            break
          elif [ "$status" = "Failed" ]; then
            echo "‚ùå ADE environment deployment failed!"
            exit 1
          fi
          
          sleep 30
          elapsed=$((elapsed + 30))
        done
        
        if [ $elapsed -ge $timeout ]; then
          echo "‚ùå ADE environment deployment timed out after 10 minutes!"
          exit 1
        fi
    
    - name: Extract ADE Outputs
      id: extract-outputs
      run: |
        echo "üìã Extracting outputs from ADE environment..."
        
        # Get environment details
        ENV_DETAILS=$(az devcenter dev environment show \
          --dev-center-name "devecnter-eus-dev" \
          --project-name "ai-foundry" \
          --name "${{ env.ADE_ENVIRONMENT_NAME }}" \
          --output json)
        
        # Extract resource group name (assuming it follows the pattern)
        RESOURCE_GROUP=$(echo "$ENV_DETAILS" | jq -r '.resourceGroupId' | sed 's|.*/||')
        echo "RESOURCE_GROUP_NAME=$RESOURCE_GROUP" >> $GITHUB_ENV
        
        # Find Static Web App in the resource group
        STATIC_WEB_APP=$(az staticwebapp list \
          --resource-group "$RESOURCE_GROUP" \
          --query "[0].name" \
          --output tsv)
        
        if [ -z "$STATIC_WEB_APP" ] || [ "$STATIC_WEB_APP" = "null" ]; then
          echo "‚ùå No Static Web App found in resource group: $RESOURCE_GROUP"
          exit 1
        fi
        
        echo "STATIC_WEB_APP_NAME=$STATIC_WEB_APP" >> $GITHUB_ENV
        
        # Get Static Web App URL
        STATIC_WEB_APP_URL=$(az staticwebapp show \
          --name "$STATIC_WEB_APP" \
          --resource-group "$RESOURCE_GROUP" \
          --query "defaultHostname" \
          --output tsv)
        
        echo "STATIC_WEB_APP_URL=https://$STATIC_WEB_APP_URL" >> $GITHUB_ENV
        
        echo "‚úÖ Extracted ADE outputs:"
        echo "  - Resource Group: $RESOURCE_GROUP"
        echo "  - Static Web App: $STATIC_WEB_APP"
        echo "  - URL: https://$STATIC_WEB_APP_URL"
    
    - name: Get Static Web App Deployment Token
      id: get-token
      run: |
        echo "üîë Getting deployment token for Static Web App..."
        
        DEPLOYMENT_TOKEN=$(az staticwebapp secrets list \
          --name "${{ env.STATIC_WEB_APP_NAME }}" \
          --resource-group "${{ env.RESOURCE_GROUP_NAME }}" \
          --query "properties.apiKey" \
          --output tsv)
        
        if [ -z "$DEPLOYMENT_TOKEN" ]; then
          echo "‚ùå Failed to get deployment token for Static Web App!"
          exit 1
        fi
        
        echo "‚úÖ Deployment token retrieved successfully"
        echo "DEPLOYMENT_TOKEN=$DEPLOYMENT_TOKEN" >> $GITHUB_ENV
    
    - name: Deploy Frontend Code to Static Web App
      uses: Azure/static-web-apps-deploy@v1
      with:
        azure_static_web_apps_api_token: ${{ env.DEPLOYMENT_TOKEN }}
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        action: "upload"
        app_location: "./src/frontend/dist"
        skip_app_build: true
        skip_api_build: true
    
    - name: Deployment Success
      run: |
        echo "‚úÖ Frontend code deployed successfully!"
        echo "üîó Application URL: ${{ env.STATIC_WEB_APP_URL }}"
    
    - name: ADE Deployment Summary
      run: |
        echo "## üöÄ ADE Frontend Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ‚úÖ Deployment Successful" >> $GITHUB_STEP_SUMMARY
        echo "- **ADE Environment**: \`${{ env.ADE_ENVIRONMENT_NAME }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Resource Group**: \`${{ env.RESOURCE_GROUP_NAME }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Static Web App**: \`${{ env.STATIC_WEB_APP_NAME }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Application URL**: [${{ env.STATIC_WEB_APP_URL }}](${{ env.STATIC_WEB_APP_URL }})" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üîß ADE Configuration Used" >> $GITHUB_STEP_SUMMARY
        echo "- **DevCenter**: devecnter-eus-dev" >> $GITHUB_STEP_SUMMARY
        echo "- **Project**: ai-foundry" >> $GITHUB_STEP_SUMMARY
        echo "- **Catalog**: ai-in-abox-infrastructure" >> $GITHUB_STEP_SUMMARY
        echo "- **Environment Definition**: AI_Foundry_SPA_Frontend" >> $GITHUB_STEP_SUMMARY
        echo "- **Environment Type**: dev" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üßπ Environment Cleanup" >> $GITHUB_STEP_SUMMARY
        echo "‚ö†Ô∏è **Note**: ADE environment \`${{ env.ADE_ENVIRONMENT_NAME }}\` remains active for testing." >> $GITHUB_STEP_SUMMARY
        echo "Manual cleanup may be required via ADE portal if automatic cleanup fails." >> $GITHUB_STEP_SUMMARY
    
    - name: Cleanup ADE Environment
      if: always()
      run: |
        echo "üßπ Cleaning up ADE environment..."
        
        if [ -n "${{ env.ADE_ENVIRONMENT_NAME }}" ]; then
          echo "üóëÔ∏è Deleting ADE environment: ${{ env.ADE_ENVIRONMENT_NAME }}"
          
          # Attempt to delete the ADE environment
          az devcenter dev environment delete \
            --dev-center-name "devecnter-eus-dev" \
            --project-name "ai-foundry" \
            --name "${{ env.ADE_ENVIRONMENT_NAME }}" \
            --yes \
            --no-wait || echo "‚ö†Ô∏è Failed to delete ADE environment (may require manual cleanup)"
          
          echo "‚úÖ ADE environment cleanup initiated"
        else
          echo "‚ÑπÔ∏è No ADE environment to clean up"
        fi

  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [bicep-validation, frontend-build, backend-build, deploy-ade-frontend]
    if: always()
    
    steps:
    - name: Download frontend artifacts
      uses: actions/download-artifact@v4
      with:
        name: frontend-dist
        path: ./artifacts/frontend/
        
    - name: Download backend artifacts
      uses: actions/download-artifact@v4
      with:
        name: backend-publish
        path: ./artifacts/backend/
        
    - name: Display build summary
      run: |
        echo "## üèóÔ∏è Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Bicep validation summary
        if [ "${{ needs.bicep-validation.result }}" = "success" ]; then
          echo "### ‚úÖ Bicep Infrastructure Validation Successful" >> $GITHUB_STEP_SUMMARY
          echo "- **Templates validated**: Main orchestrator, Backend environment, Frontend environment" >> $GITHUB_STEP_SUMMARY
          echo "- **Validation scope**: Syntax, parameters, dependencies, RBAC" >> $GITHUB_STEP_SUMMARY
        else
          echo "### ‚ùå Bicep Infrastructure Validation Failed" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ needs.bicep-validation.result }}" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Frontend summary
        if [ -d "./artifacts/frontend" ]; then
          echo "### ‚úÖ Frontend Build Successful" >> $GITHUB_STEP_SUMMARY
          echo "- **Build output**: $(du -sh ./artifacts/frontend | cut -f1)" >> $GITHUB_STEP_SUMMARY
          echo "- **Files**: $(find ./artifacts/frontend -type f | wc -l) files generated" >> $GITHUB_STEP_SUMMARY
        else
          echo "### ‚ùå Frontend Build Failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Backend summary
        if [ -d "./artifacts/backend" ]; then
          echo "### ‚úÖ Backend Build Successful" >> $GITHUB_STEP_SUMMARY
          echo "- **Build output**: $(du -sh ./artifacts/backend | cut -f1)" >> $GITHUB_STEP_SUMMARY
          echo "- **Files**: $(find ./artifacts/backend -type f | wc -l) files generated" >> $GITHUB_STEP_SUMMARY
        else
          echo "### ‚ùå Backend Build Failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # ADE deployment summary (only shows on main branch pushes)
        if [ "${{ github.event_name }}" = "push" ] && [ "${{ github.ref }}" = "refs/heads/main" ]; then
          if [ "${{ needs.deploy-ade-frontend.result }}" = "success" ]; then
            echo "### ‚úÖ ADE Frontend Deployment Successful" >> $GITHUB_STEP_SUMMARY
            echo "- **Status**: Frontend deployed via Azure Deployment Environment" >> $GITHUB_STEP_SUMMARY
            echo "- **Environment**: Automatically created and deployed" >> $GITHUB_STEP_SUMMARY
            echo "- **Cleanup**: Environment cleanup initiated automatically" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.deploy-ade-frontend.result }}" = "failure" ]; then
            echo "### ‚ùå ADE Frontend Deployment Failed" >> $GITHUB_STEP_SUMMARY
            echo "- **Status**: ${{ needs.deploy-ade-frontend.result }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Note**: Check job logs for detailed error information" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.deploy-ade-frontend.result }}" = "skipped" ]; then
            echo "### ‚è≠Ô∏è ADE Frontend Deployment Skipped" >> $GITHUB_STEP_SUMMARY
            echo "- **Reason**: ADE deployment only runs on main branch pushes" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "### üìã Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "- Review build artifacts if needed" >> $GITHUB_STEP_SUMMARY
        echo "- Run local tests: \`npm test\` (frontend) and \`dotnet test\` (backend)" >> $GITHUB_STEP_SUMMARY
        echo "- Deploy to Azure using deployment scripts in \`deploy-scripts/\`" >> $GITHUB_STEP_SUMMARY
        if [ "${{ github.event_name }}" = "push" ] && [ "${{ github.ref }}" = "refs/heads/main" ]; then
          echo "- ADE frontend deployment tested automatically on main branch" >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: Check build status
      run: |
        # Base build requirements (always checked)
        base_success=true
        if [ "${{ needs.bicep-validation.result }}" != "success" ]; then
          base_success=false
        fi
        if [ "${{ needs.frontend-build.result }}" != "success" ]; then
          base_success=false
        fi
        if [ "${{ needs.backend-build.result }}" != "success" ]; then
          base_success=false
        fi
        
        # ADE deployment check (only on main branch pushes)
        ade_success=true
        if [ "${{ github.event_name }}" = "push" ] && [ "${{ github.ref }}" = "refs/heads/main" ]; then
          if [ "${{ needs.deploy-ade-frontend.result }}" != "success" ]; then
            ade_success=false
          fi
        fi
        
        if [ "$base_success" = "true" ] && [ "$ade_success" = "true" ]; then
          echo "‚úÖ All builds, validations, and deployments completed successfully!"
          exit 0
        else
          echo "‚ùå One or more jobs failed:"
          echo "Bicep Validation: ${{ needs.bicep-validation.result }}"
          echo "Frontend Build: ${{ needs.frontend-build.result }}"
          echo "Backend Build: ${{ needs.backend-build.result }}"
          if [ "${{ github.event_name }}" = "push" ] && [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "ADE Frontend Deployment: ${{ needs.deploy-ade-frontend.result }}"
          fi
          exit 1
        fi
