name: Shared Bicep Build

on:
  workflow_call:
    inputs:
      working-directory:
        description: 'Working directory for the workflow'
        required: false
        type: string
        default: '.'
      artifact-name:
        description: 'Name for the infrastructure build artifacts'
        required: false
        type: string
        default: 'infrastructure'
    outputs:
      build-result:
        description: 'Result of the Bicep build and validation'
        value: ${{ jobs.bicep-build.outputs.result }}

jobs:
  bicep-build:
    name: Bicep Infrastructure Build
    runs-on: ubuntu-latest
    outputs:
      result: ${{ steps.validation.outputs.result }}
    permissions:
      contents: read
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5
      
    - name: Azure CLI Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
      
    - name: Validate Main Orchestrator Template
      id: validation
      run: |
        echo "ðŸ” Validating main orchestrator Bicep template..."
        az deployment sub what-if \
          --location "eastus2" \
          --template-file "infra/main-orchestrator.bicep" \
          --parameters "infra/dev-orchestrator.parameters.bicepparam"
        echo "âœ… Main orchestrator validation completed"
        echo "result=success" >> $GITHUB_OUTPUT
          
    - name: Create temporary resource group for validation
      run: |
        echo "ðŸ—ï¸ Creating temporary resource group for validation..."
        TEMP_RG="rg-temp-bicep-validation-${{ github.run_number }}"
        az group create --name "$TEMP_RG" --location "eastus2" --tags Purpose=CI-Validation RunNumber=${{ github.run_number }}
        echo "TEMP_RESOURCE_GROUP=$TEMP_RG" >> $GITHUB_ENV
        
    - name: Validate Backend Environment Template
      run: |
        echo "ðŸ” Validating backend environment Bicep template..."
        az deployment group what-if \
          --resource-group "${{ env.TEMP_RESOURCE_GROUP }}" \
          --template-file "infra/environments/backend/main.bicep" \
          --parameters "infra/environments/backend/example-parameters.bicepparam"
        echo "âœ… Backend environment validation completed"
          
    - name: Validate Frontend Environment Template
      run: |
        echo "ðŸ” Validating frontend environment Bicep template..."
        az deployment group what-if \
          --resource-group "${{ env.TEMP_RESOURCE_GROUP }}" \
          --template-file "infra/environments/frontend/main.bicep" \
          --parameters "infra/environments/frontend/example-parameters.bicepparam"
        echo "âœ… Frontend environment validation completed"
        
    - name: Validate ADE Manifests
      run: |
        echo "ðŸ” Validating Azure Deployment Environment manifests..."
        
        # Install Python YAML parser for validation
        python3 -c "import yaml" || pip3 install pyyaml
        
        # Validate Frontend ADE manifest
        echo "  â€¢ Validating frontend/environment.yaml..."
        python3 -c "
        import yaml
        with open('infra/environments/frontend/environment.yaml', 'r') as f:
            yaml.safe_load(f)
        print('    âœ… Frontend ADE manifest syntax valid')
        "
        
        # Validate Backend ADE manifest  
        echo "  â€¢ Validating backend/environment.yaml..."
        python3 -c "
        import yaml
        with open('infra/environments/backend/environment.yaml', 'r') as f:
            yaml.safe_load(f)
        print('    âœ… Backend ADE manifest syntax valid')
        "
        
        echo "âœ… ADE manifest validation completed"
          
    - name: Cleanup temporary resource group
      if: always()
      run: |
        echo "ðŸ§¹ Cleaning up temporary resource group..."
        if [ -n "${{ env.TEMP_RESOURCE_GROUP }}" ]; then
          az group delete --name "${{ env.TEMP_RESOURCE_GROUP }}" --yes --no-wait
        fi
        
    - name: Bicep validation summary
      run: |
        echo "## ðŸ—ï¸ Bicep Infrastructure Validation Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… Templates Validated Successfully" >> $GITHUB_STEP_SUMMARY
        echo "- **Main Orchestrator**: \`infra/main-orchestrator.bicep\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Backend Environment**: \`infra/environments/backend/main.bicep\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Frontend Environment**: \`infra/environments/frontend/main.bicep\`" >> $GITHUB_STEP_SUMMARY
        echo "- **ADE Manifests**: \`environment.yaml\` files for frontend and backend" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ” Validation Scope" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Bicep template syntax and compilation" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Parameter file compatibility" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Module references and paths" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… RBAC role definitions and scope" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Resource dependencies and naming" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… ADE manifest YAML syntax and schema compliance" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ Infrastructure Artifact Created" >> $GITHUB_STEP_SUMMARY
        echo "All validated Bicep files packaged as \`${{ inputs.artifact-name }}\` artifact for deployment reuse." >> $GITHUB_STEP_SUMMARY
    
    - name: Upload infrastructure build artifacts
      uses: actions/upload-artifact@v6
      with:
        name: ${{ inputs.artifact-name }}
        path: infra/
        retention-days: 5
