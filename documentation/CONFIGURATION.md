# Configuration Guide

This guide covers all configuration aspects of the [Azure AI Foundry](https://learn.microsoft.com/en-us/azure/ai-foundry/) SPA project, including environment variables, deployment parameters, and service configurations.

## üåê Environment Variables

### Frontend Configuration

The frontend uses environment-specific configuration files in `src/frontend/environments/`:

#### `dev.js` (Development)
```javascript
export const environment = {
  production: false,
  apiBaseUrl: 'http://localhost:7071', // Local Azure Functions
  aiFoundryEndpoint: process.env.AI_FOUNDRY_ENDPOINT || 'your-dev-endpoint',
  agentName: 'AI in A Box',
  enableDebugLogging: true
};
```

#### `index.js` (Production)
```javascript
export const environment = {
  production: true,
  apiBaseUrl: '', // Uses same origin as frontend
  aiFoundryEndpoint: process.env.AI_FOUNDRY_ENDPOINT,
  agentName: 'AI in A Box',
  enableDebugLogging: false
};
```

### Backend Configuration

#### Local Development (`local.settings.json`)
```json
{
  "IsEncrypted": false,
  "Values": {
    "AzureWebJobsStorage": "UseDevelopmentStorage=true",
    "FUNCTIONS_WORKER_RUNTIME": "dotnet-isolated",
    "AI_FOUNDRY_ENDPOINT": "https://your-ai-foundry.cognitiveservices.azure.com/",
    "AI_FOUNDRY_DEPLOYMENT": "your-deployment-name",
    "AI_FOUNDRY_AGENT_NAME": "AI in A Box",
    "APPLICATIONINSIGHTS_CONNECTION_STRING": "InstrumentationKey=your-key"
  }
}
```

#### [Azure](https://learn.microsoft.com/en-us/azure/) Deployment Configuration
These are set via [Azure Bicep](https://learn.microsoft.com/en-us/azure/azure-resource-manager/bicep/) deployment parameters:

| Variable | Description | Example |
|----------|-------------|---------|
| `AI_FOUNDRY_ENDPOINT` | Azure AI Foundry service endpoint URL | `https://your-service.cognitiveservices.azure.com/` |
| `AI_FOUNDRY_DEPLOYMENT` | Deployment/model name | `gpt-4.1-mini` |
| `AI_FOUNDRY_AGENT_NAME` | Agent identifier | `AI in A Box` |
| `APPLICATIONINSIGHTS_CONNECTION_STRING` | [Application Insights](https://learn.microsoft.com/en-us/azure/azure-monitor/app/app-insights-overview) connection | Auto-generated by Azure Bicep |

## üèóÔ∏è Infrastructure Configuration

### Azure Bicep Parameters

#### Main Orchestrator Parameters (`dev-orchestrator.parameters.bicepparam`)
```bicep
using './main-orchestrator.bicep'

// Core Configuration
param environmentName = 'dev'
param location = 'East US 2'
param principalId = 'your-user-object-id'

// Azure AI Foundry Configuration
param aiFoundryEndpoint = 'https://your-ai-foundry.cognitiveservices.azure.com/'
param aiFoundryDeployment = 'gpt-4.1-mini'
param aiFoundryAgentName = 'AI in A Box'

// Optional: Existing [Log Analytics Workspace](https://learn.microsoft.com/en-us/azure/azure-monitor/logs/log-analytics-overview)
param existingLogAnalyticsWorkspaceName = 'your-existing-workspace'
param existingLogAnalyticsResourceGroupName = 'your-existing-rg'
```

### Resource Naming Convention

The project uses a consistent naming pattern:
```
{resourceType}-{projectName}-{environment}-{uniqueString(subscription().id, applicationName, component)}
```

Examples:
- [Azure Static Web Apps](https://learn.microsoft.com/en-us/azure/static-web-apps/): `stapp-ai-foundry-spa-frontend-dev-abc123def` (where `abc123def` is generated by uniqueString())
- [Azure Functions](https://learn.microsoft.com/en-us/azure/azure-functions/): `func-ai-foundry-spa-backend-dev-xyz789ghi`
- Resource Groups: `rg-ai-foundry-spa-frontend-dev-abc123def`

**Note**: The unique string is automatically generated using Azure's `uniqueString()` function based on subscription ID, application name, and component type for deterministic but unique naming.

## üîí Security Configuration

### [Managed Identity](https://learn.microsoft.com/en-us/entra/identity/managed-identities-azure-resources/)

The Azure Functions uses **system-assigned managed identity** with minimal required permissions:

- **[Azure AI Developer](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#azure-ai-developer)** role scoped to the Azure AI Foundry resource
- **[Storage Blob Data Contributor](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#storage-blob-data-contributor)** for Azure Functions storage needs

### [CORS Configuration](https://learn.microsoft.com/en-us/azure/azure-functions/functions-how-to-use-azure-function-app-settings#cors)

#### Development CORS
```json
{
  "cors": {
    "allowedOrigins": [
      "http://localhost:5173",
      "http://localhost:4173"
    ],
    "supportCredentials": false
  }
}
```

#### Production CORS
```json
{
  "cors": {
    "allowedOrigins": [
      "https://your-static-web-app.azurestaticapps.net"
    ],
    "supportCredentials": false
  }
}
```

### Key Vault Integration (Optional)

For enhanced security, sensitive configuration can be stored in Azure Key Vault:

```bicep
// Reference Key Vault secrets in Function App
resource functionApp 'Microsoft.Web/sites@2023-01-01' = {
  properties: {
    siteConfig: {
      appSettings: [
        {
          name: 'AI_FOUNDRY_ENDPOINT'
          value: '@Microsoft.KeyVault(VaultName=${keyVaultName};SecretName=ai-foundry-endpoint)'
        }
      ]
    }
  }
}
```

## üìä Monitoring Configuration

### Application Insights

Both frontend and backend have separate Application Insights instances:

#### Frontend Monitoring
- **User interactions** and page views
- **JavaScript errors** and performance metrics
- **Custom events** for AI conversation tracking

#### Backend Monitoring
- **Function execution** metrics and duration
- **Dependency calls** to AI Foundry
- **Error logging** and exception tracking
- **Performance counters** and resource usage

### Log Analytics Workspace

Shared workspace consolidates logs from:
- Frontend Application Insights
- Backend Application Insights
- Function App diagnostic logs
- Static Web App logs and analytics

## üîß Service Configuration

### Static Web App Configuration

The Static Web App is configured for optimal SPA performance:

```bicep
{
  "appLocation": "/dist",
  "outputLocation": "",
  "skipGithubActionWorkflowGeneration": true
}
```

### Function App Configuration

#### Host Configuration (`host.json`)
```json
{
  "version": "2.0",
  "functionTimeout": "00:05:00",
  "extensions": {
    "http": {
      "routePrefix": "api"
    }
  },
  "logging": {
    "applicationInsights": {
      "samplingSettings": {
        "isEnabled": true,
        "excludedTypes": "Request"
      }
    }
  }
}
```

#### Runtime Configuration
- **.NET 8 Isolated** runtime
- **Azure Functions v4** host
- **HTTP trigger** with CORS support
- **System-assigned managed identity**

## üöÄ Deployment Configuration

### Azure CLI Deployment

The deployment scripts use these key configurations:

```powershell
# Main deployment command
az deployment sub create `
  --template-file "infra/main-orchestrator.bicep" `
  --parameters "infra/dev-orchestrator.parameters.bicepparam" `
  --location "East US 2"
```

### Multi-Resource Group Strategy

- **Frontend Resource Group**: Contains static hosting and monitoring
- **Backend Resource Group**: Contains compute, storage, and monitoring
- **Cross-RG Permissions**: RBAC module handles permissions across groups

## üîç Validation and Testing

### Configuration Validation Scripts

```powershell
# Validate Function App configuration
./tests/core/Test-FunctionEndpoints.ps1 -BaseUrl $functionAppUrl

# Test AI Foundry connectivity
./tests/Test-FunctionAppAccess.ps1
```

### Health Checks

The Function App includes health check endpoints:
- `/api/health` - Basic health status
- `/api/health/ai-foundry` - AI Foundry connectivity test

## üìù Configuration Checklist

### Pre-Deployment
- [ ] AI Foundry endpoint URL configured
- [ ] Deployment/model name specified
- [ ] User principal ID for RBAC permissions
- [ ] Environment name and location set

### Post-Deployment
- [ ] Function App responds to health checks
- [ ] Static website serves content correctly
- [ ] AI Foundry integration works
- [ ] Application Insights receiving telemetry
- [ ] CORS allows frontend to call backend

### Troubleshooting Common Issues

#### Function App Can't Access AI Foundry
1. Verify managed identity is enabled
2. Check Azure AI Developer role assignment
3. Validate AI Foundry endpoint URL
4. Test network connectivity

#### Frontend Can't Call Backend
1. Check CORS configuration
2. Verify Function App URL in frontend config
3. Test Function App accessibility
4. Check browser developer tools for errors

## üîó Related Documentation

- [Setup Guide](SETUP.md) - Initial deployment steps
- [Development Guide](DEVELOPMENT.md) - Local development setup
- [Multi-RG Architecture](MULTI_RG_ARCHITECTURE.md) - Infrastructure overview
- [Public Mode Setup](PUBLIC_MODE_SETUP.md) - Authentication details
